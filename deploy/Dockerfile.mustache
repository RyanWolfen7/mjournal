# https://registry.hub.docker.com/u/nodesource/node/
FROM nodesource/wheezy:4.2.2
# get the slow/big stuff done early so the cache is rarely invalidated
ENV DEBIAN_FRONTEND noninteractive

# npm prereqs: build_essential, python
# bower prereqs: git-core
# runit contains svlogd which handles log rotation
RUN apt-get update && apt-get install -y \
  build-essential \
  git-core \
  runit \
  python

# Clean up APT when done.
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

WORKDIR /opt
ADD ./package.json  /opt/package.json
RUN npm install
ADD ./bower.json  /opt/bower.json
RUN ./node_modules/.bin/bower --allow-root --config.analytics=false install

# OK, all the slow stuff has been run and hopefully cached
ADD app /opt/app
ADD wwwroot /opt/wwwroot
ADD migrations /opt/migrations
ADD knexfile.js config.default.js /opt/
ADD bin/build-browserify.sh /opt/bin/build-browserify.sh
#Yes this ln command needs to run twice
RUN ln -nsf ../app node_modules/app && \
  bash ./bin/build-browserify.sh && \
  npm prune --production && \
  ln -nsf ../app node_modules/app

ENV NODE_ENV production
EXPOSE {{port}}
USER www-data
CMD /opt/app/server.js 2>&1 | svlogd /var/log/{{appName}}
