# https://registry.hub.docker.com/u/nodesource/node/
FROM nodesource/node:wheezy
#get the slow/big stuff done early so the cache is rarely invalidated
ENV DEBIAN_FRONTEND noninteractive

#npm prereqs: build_essential, python
#bower prereqs: git-core
RUN apt-get update && apt-get install -y \
  build-essential \
  git-core \
  python

# Clean up APT when done.
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

WORKDIR /home/app
ADD package.json  /home/app/package.json
ADD bower.json  /home/app/bower.json
RUN npm install --production
RUN bower --allow-root --config.analytics=false install

#OK, all the slow stuff has been run and hopefully cached
RUN cd node_modules && ln -nsf ../app

ADD deploy/{{appName}}-run.sh /home/app/{{appName}}-run.sh
ADD app /home/app/app
ADD wwwroot /home/app/wwwroot
ADD config.default.js /home/app/config.default.js
EXPOSE {{port}} 22
CMD ["/home/app/{{appName}}-run.sh"]
